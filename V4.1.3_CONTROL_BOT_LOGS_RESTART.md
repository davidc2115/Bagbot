# ğŸ›ï¸ BAG Bot Manager v4.1.3 - ContrÃ´le Bot & Logs

## ğŸ“‹ RÃ©sumÃ©

Version **4.1.3** ajoute un systÃ¨me complet de contrÃ´le du bot avec consultation des logs et redÃ©marrage PM2.

---

## âœ¨ Nouvelles FonctionnalitÃ©s

### ğŸ›ï¸ Ã‰cran ContrÃ´le Bot (Remplace Home)

L'Ã©cran d'accueil a Ã©tÃ© transformÃ© en un centre de contrÃ´le complet avec **3 onglets** :

#### ğŸ“Š Onglet 1 : Statut
- **Statut du bot** : En ligne / Hors ligne avec indicateur visuel
- **Statistiques serveur** :
  - Nombre de membres
  - Nombre de salons
  - Nombre de rÃ´les
- **Informations bot** :
  - Nombre de commandes disponibles
  - Version du bot

#### ğŸ“ Onglet 2 : Logs
- **Sous-onglets Bot / Dashboard**
- **100 derniÃ¨res lignes de logs** en temps rÃ©el
- **Bouton rafraÃ®chir** pour recharger les logs
- **Affichage monospace** pour meilleure lisibilitÃ©
- **Chargement asynchrone** avec indicateur

#### ğŸ”§ Onglet 3 : Actions (Fondateur uniquement)
- **Zone sÃ©curisÃ©e** avec avertissement
- **RedÃ©marrer Bot PM2** :
  - RedÃ©marre le processus `bagbot` sur la Freebox
  - Bouton vert avec icÃ´ne ğŸ”„
  - Indicateur de progression pendant le redÃ©marrage
- **RedÃ©marrer Dashboard PM2** :
  - RedÃ©marre le processus `dashboard-v2` sur la Freebox
  - Bouton bleu avec icÃ´ne ğŸ”„
  - Indicateur de progression pendant le redÃ©marrage

---

## ğŸ”Œ Nouveaux Endpoints API

### GET `/api/admin/logs/:service`

RÃ©cupÃ¨re les logs d'un service PM2.

**ParamÃ¨tres** :
- `service` : `bot` ou `dashboard`

**RÃ©ponse** :
```json
{
  "service": "bot",
  "logs": "... 100 derniÃ¨res lignes ..."
}
```

**SÃ©curitÃ©** : RÃ©servÃ© au fondateur (ID: `943487722738311219`)

---

### POST `/api/admin/restart/:service`

RedÃ©marre un service PM2.

**ParamÃ¨tres** :
- `service` : `bot` ou `dashboard`

**RÃ©ponse** :
```json
{
  "success": true,
  "service": "bot",
  "message": "Service bot restarted successfully",
  "output": "pm2 restart output..."
}
```

**SÃ©curitÃ©** : RÃ©servÃ© au fondateur (ID: `943487722738311219`)

---

## ğŸ› ï¸ Modifications Techniques

### Backend (`dashboard-v2/server-v2.js` et `backend/server.js`)

**Ajouts** (lignes ~2889-2978) :
```javascript
// GET /api/admin/logs/:service
app.get('/api/admin/logs/:service', (req, res) => {
  // Authentification fondateur
  // ExÃ©cution: pm2 logs [service] --lines 100 --nostream
  // Retour: JSON avec les logs
});

// POST /api/admin/restart/:service
app.post('/api/admin/restart/:service', express.json(), (req, res) => {
  // Authentification fondateur
  // ExÃ©cution: pm2 restart [service]
  // Retour: JSON avec succÃ¨s/erreur
});
```

**DÃ©pendances** :
- `child_process.exec` pour exÃ©cuter les commandes PM2

---

### Android (`android-app/app/src/main/java/com/bagbot/manager/App.kt`)

**Nouveau Composable** (lignes ~2235-2628) :
```kotlin
@Composable
fun BotControlScreen(
    api: ApiClient,
    json: Json,
    scope: CoroutineScope,
    snackbar: SnackbarHostState,
    botOnline: Boolean,
    botStats: JsonObject?,
    members: Map<String, String>,
    channels: Map<String, String>,
    roles: Map<String, String>,
    isFounder: Boolean
)
```

**Fonctions internes** :
- `loadLogs(service: String)` : Charge les logs via API
- `restartService(service: String)` : RedÃ©marre un service via API

**Ã‰tats** :
- `selectedTab` : Onglet actif (0=Statut, 1=Logs, 2=Actions)
- `botLogs` / `dashboardLogs` : Contenu des logs
- `isLoadingLogs` : Indicateur de chargement
- `isRestarting` : Indicateur de redÃ©marrage en cours

**Remplacement** (ligne ~1425) :
```kotlin
// Avant:
tab == 0 -> { HomeScreen(...) }

// AprÃ¨s:
tab == 0 -> { BotControlScreen(...) }
```

---

### Workflow GitHub (`build-android.yml`)

**Mise Ã  jour** (lignes 59-130) :
- Ajout section "ContrÃ´le Bot (NOUVEAU!)"
- Version mise Ã  jour : `4.1.3 (versionCode 413)`

---

### Version (`build.gradle.kts`)

```kotlin
versionCode = 413
versionName = "4.1.3"
```

---

## ğŸ“± Utilisation

### 1ï¸âƒ£ Ouvrir l'application

L'onglet principal affiche maintenant le **ContrÃ´le Bot** au lieu du Home.

### 2ï¸âƒ£ Consulter les logs

1. Cliquer sur l'onglet **ğŸ“ Logs**
2. Cliquer sur **ğŸ¤– Bot** ou **ğŸ“Š Dashboard**
3. Les 100 derniÃ¨res lignes s'affichent automatiquement
4. Cliquer sur ğŸ”„ pour rafraÃ®chir

### 3ï¸âƒ£ RedÃ©marrer un service (Fondateur uniquement)

1. Cliquer sur l'onglet **ğŸ”§ Actions**
2. Choisir :
   - **ğŸ”„ RedÃ©marrer le Bot** (bouton vert)
   - **ğŸ”„ RedÃ©marrer le Dashboard** (bouton bleu)
3. Confirmer et attendre la notification de succÃ¨s

**Note** : Les boutons de redÃ©marrage sont dÃ©sactivÃ©s pendant l'opÃ©ration.

---

## ğŸ” SÃ©curitÃ©

### AccÃ¨s restreint

- **Onglet Actions** : Visible uniquement si `isFounder == true`
- **Endpoints API** : VÃ©rification du `userId === '943487722738311219'`
- **Tokens** : Authentification Bearer token requise

### Logs

Chaque redÃ©marrage est enregistrÃ© dans les logs serveur :
```
âœ… Service bot restarted by Username#1234
```

---

## ğŸ§ª Tests

### âœ… Ã‰cran ContrÃ´le Bot
- [x] Affichage statut bot (en ligne/hors ligne)
- [x] Compteurs serveur (membres, salons, rÃ´les)
- [x] Navigation entre onglets

### âœ… Logs
- [x] Chargement logs bot
- [x] Chargement logs dashboard
- [x] Bouton rafraÃ®chir
- [x] Indicateur de chargement

### âœ… Actions (Fondateur)
- [x] Onglet visible uniquement pour fondateur
- [x] RedÃ©marrage bot
- [x] RedÃ©marrage dashboard
- [x] Indicateur de progression
- [x] Notifications de succÃ¨s/erreur

### âœ… API Backend
- [x] GET `/api/admin/logs/bot`
- [x] GET `/api/admin/logs/dashboard`
- [x] POST `/api/admin/restart/bot`
- [x] POST `/api/admin/restart/dashboard`
- [x] SÃ©curitÃ© fondateur

---

## ğŸ“Š Statistiques

### Fichiers modifiÃ©s : **4**
1. `dashboard-v2/server-v2.js` (+92 lignes)
2. `backend/server.js` (+92 lignes)
3. `android-app/app/src/main/java/com/bagbot/manager/App.kt` (+393 lignes)
4. `android-app/app/build.gradle.kts` (version)
5. `.github/workflows/build-android.yml` (description)

### Endpoints ajoutÃ©s : **2**
- GET `/api/admin/logs/:service`
- POST `/api/admin/restart/:service`

### Composables ajoutÃ©s : **1**
- `BotControlScreen` (avec 3 onglets)

### Lignes de code : **~577 lignes**

---

## ğŸš€ DÃ©ploiement

### Backend
```bash
bash /workspace/restart-dashboard.sh
```

### APK
```bash
git add .
git commit -m "feat(v4.1.3): ContrÃ´le bot avec logs et restart PM2"
git tag -a v4.1.3 -m "Version 4.1.3 - Bot Control, Logs & PM2 Restart"
git push origin main --tags
```

Le workflow GitHub Actions compile automatiquement l'APK et crÃ©e une release.

---

## ğŸ¯ Avantages

### Pour l'utilisateur
- âœ… **ContrÃ´le total** depuis le mobile
- âœ… **Diagnostic rapide** avec les logs
- âœ… **Pas besoin de SSH** pour redÃ©marrer les services
- âœ… **Interface intuitive** avec tabs

### Pour la maintenance
- âœ… **Autonomie** : RedÃ©marrage sans accÃ¨s serveur
- âœ… **Debugging** : Logs accessibles en temps rÃ©el
- âœ… **SÃ©curitÃ©** : Actions limitÃ©es au fondateur
- âœ… **TraÃ§abilitÃ©** : Logs des actions effectuÃ©es

---

## ğŸ“ Notes

### PM2
Les commandes exÃ©cutÃ©es cÃ´tÃ© serveur :
```bash
pm2 logs bagbot --lines 100 --nostream
pm2 logs dashboard-v2 --lines 100 --nostream
pm2 restart bagbot
pm2 restart dashboard-v2
```

### Limitations connues
- SSH direct vers Freebox : Timeout (port 22 et 2222)
- Solution : Utilisation des endpoints API Ã  la place

---

## ğŸ”— Liens Utiles

- **Dashboard Web** : http://88.174.155.230:33002
- **GitHub Releases** : https://github.com/YOUR-REPO/releases
- **Documentation complÃ¨te** : `/workspace/docs/`

---

**Version** : 4.1.3  
**Date** : 20 DÃ©cembre 2024  
**Statut** : âœ… Production Ready
